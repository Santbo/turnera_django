{% extends "_base.html" %}

{% block titulo %}Horarios{% endblock titulo %}

{% block contenido %}

  <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">

    <div class="mb-6">
      <h1 class="text-4xl font-bold inline-block tracking-tight bg-gradient-to-r from-sky-700 to-indigo-600 bg-clip-text text-transparent">
        Horarios
      </h1>

      <p class="mt-2 text-sm md:text-base text-slate-600 leading-relaxed">
        Seleccioná los días que trabajás y las franjas horarias en las que lo hacés.
      </p>
    </div>

    {% comment %} DIV error {% endcomment %}
    <div
      id="div-errores"
      class="hidden mb-6 rounded-xl border border-rose-300 bg-rose-50 p-4 shadow-sm animate-fade-in"
    >
      <div class="flex items-start gap-3">
        <i class="fa fa-triangle-exclamation text-xl text-rose-700"></i>

        <div class="flex-1">
          <h3 class="text-sm font-semibold text-rose-700">
            Se encontraron errores al guardar los horarios:
          </h3>

          <ul id="ul-errores" class="mt-2 list-disc space-y-1 text-sm text-rose-700">
          </ul>
        </div>
        <button
          type="button"
          class="text-rose-600 hover:text-rose-800 cursor-pointer"
          onclick="document.getElementById('div-errores').remove()"
        >
          ✕
        </button>
      </div>
    </div>

    {% comment %} DIV exito {% endcomment %}
    <div
          id="div-exito"
          class="hidden mb-6 rounded-xl border border-emerald-200 bg-emerald-50 p-4 shadow-sm"
        >
          <div class="flex items-start gap-3">
            <i class="fa fa-check text-emerald-700 text-xl"></i>

            <!-- Texto -->
            <div class="flex-1">
              <h3 class="text-sm font-semibold text-emerald-700">
                ¡Horarios guardados correctamente!
              </h3>

              <p class="mt-1 text-sm text-emerald-800">
                Todo salió perfecto. Tus cambios ya están aplicados.
              </p>
            </div>
          </div>
    </div>

    
    {% comment %} grilla de días {% endcomment %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
      {% for dia_num, dia_nombre in dias %}
        <div
          class="rounded-xl border border-slate-200 p-4"
          id="dia-{{ dia_num }}"
          data-dia="{{ dia_num }}"
        >

          {% comment %} título del día {% endcomment %}
          <div class="flex items-center justify-between mb-2">
            <div class="text-xl text-slate-900 font-semibold">
              {{ dia_nombre }}
            </div>
          </div>

          {% comment %} intervalo {% endcomment %}
          <div class="mt-3 w-full flex items-end justify-between">
            <div>
              <label class="block text-xs font-medium text-sky-700">Intervalo (en minutos)</label>
              <input
                type="number"
                min="5"
                step="5"
                value="30"
                class="intervalo-input mt-1 w-32 rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm"
              />
            </div>

            <button
              type="button"
              class="
                rounded-xl
                bg-gradient-to-r from-sky-700 to-indigo-600
                px-4 py-2.5 mt-2
                text-sm text-white font-semibold
                hover:bg-slate-50 hover:cursor-pointer"
              onclick="agregarBloque({{ dia_num }})"
            >
              Agregar franja horaria
            </button>
          </div>

          {% comment %} bloques {% endcomment %}
          <div class="mt-3 space-y-3">
            <div class="text-xs font-semibold text-slate-700">
              Bloques
            </div>

            {% comment %} contenedor de bloques {% endcomment %}
            <div id="bloques-dia-{{ dia_num }}" class="space-y-3"></div>

            {% comment %} agregar bloques {% endcomment %}

          </div>

        </div>
      {% endfor %}
    </div>

    <!-- Guardar -->
    <div class="mt-4 flex items-center gap-3">
      <button
        onclick=guardarHorarios()
        class="rounded-xl bg-sky-600 px-6 py-3 font-semibold text-white hover:bg-sky-700 cursor-pointer"
      >
        Guardar horarios
      </button>

    </div>

  </div>
{% endblock contenido %}


{% block js_final %}

<script>

const mostrarDivError = () => {
  document.getElementById("div-errores").classList.remove("hidden");
  window.scrollTo(0, 0);
}

const ocultarDivError = () => {
  document.getElementById("div-errores").classList.add("hidden");
}

const mostrarDivExito = () => {
  document.getElementById("div-exito").classList.remove("hidden");
  window.scrollTo(0, 0);

  // Hay que ocultarlo despues de un tiempo porque ocupa espacio innecesario
  setTimeout( ocultarDivExito, 5000)
}

const ocultarDivExito = () => {
  document.getElementById("div-exito").classList.add("hidden");
}

const obtenerTokenCSRF = () => {
    return document.getElementById("csrf-token").value;
}

const obtenerHTMLBloque = (idx, instancia_bloque = null) => {
  // idx es el índice del bloque que se agrega
  // instancia_bloque se usa para pasarle un bloque que tenga fecha de inicio y fin cuando se carga
  return `
      <div class="grid grid-cols-3 gap-8" data-bloque="${idx}">
        <div>
          <label class="block text-xs font-medium text-sky-700">Desde</label>
          <input
            type="time"
            class="inicio-input mt-1 w-full h-10 rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm hover:cursor-text"
            value="${instancia_bloque ? instancia_bloque.inicio : ''}"
            required
          />
        </div>

        <div>
          <label class="block text-xs font-medium text-sky-700">Hasta</label>
          <input
            type="time"
            class="fin-input mt-1 w-full h-10 rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm hover:cursor-text"
            value="${instancia_bloque ? instancia_bloque.fin : ''}"
            required
          />
        </div>

        <div class="flex items-end">
          <button
            class="
              rounded-xl border 
              border-rose-500 bg-rose-600 
              h-10 px-4 
              text-sm text-white font-semibold 
              hover:bg-rose-700 
              hover:cursor-pointer"
            type="button"
            onclick="this.closest('[data-bloque]').remove()"
          >
            Quitar
          </button>
        </div>
      </div>
    `;
}

const agregarBloque = (dia) => {
    const cont = document.getElementById(`bloques-dia-${dia}`);

    const idx = cont.children.length;

    const html = obtenerHTMLBloque(idx);

    cont.insertAdjacentHTML("beforeend", html);
}

const recolectarHorarios = () => {
    const dias = [];

    for (let d = 0; d < 7; d++) {
        const diaActual = document.getElementById(`dia-${d}`);

        const intervalo = diaActual.querySelector(".intervalo-input").value;

        const bloquesDiaActual = diaActual.querySelectorAll("[data-bloque]");
        const bloques = [];

        bloquesDiaActual.forEach(b => {
            bloques.push({
                inicio: b.querySelector(".inicio-input").value,
                fin: b.querySelector(".fin-input").value,
            });
        });

        dias.push({
            dia_semana: d,
            intervalo: intervalo,
            bloques: bloques
        });
    }

    return dias;
}

const guardarHorarios = async () => {
    const horarios = recolectarHorarios();

    try {
        const resp = await fetch("{% url 'turnos:api_horarios' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": obtenerTokenCSRF(),
            },
            body: JSON.stringify({ horarios }),
        });

        const data = await resp.json();

        if (!resp.ok) {
          //                     <span class="mt-1 block h-1.5 w-1.5 rounded-full bg-rose-600"></span>
            const htmlErrores = `
                <li class="ml-4">
                    ${data.error}
                </li>
            `;

            document.getElementById("ul-errores").innerHTML = htmlErrores;
            ocultarDivExito();
            mostrarDivError();
            return;
        }

        ocultarDivError();
        mostrarDivExito();
        window.scrollTo(0, 0);

    } catch (err) {
      ocultarDivExito();
        console.error(err);
        const htmlErrores = `
            <li class="ml-4">
                ${data.error}
            </li>
        `;
        document.getElementById("ul-errores").innerHTML = htmlErrores;
        mostrarDivError();
    }
}

const cargarHorarios = async () => {
    try {
        const resp = await fetch("{% url 'turnos:api_horarios' %}", {
            method: "GET",
            headers: {
                "X-CSRFToken": obtenerTokenCSRF(),
            }
        });

        const data = await resp.json();

        console.log("DATA:", data);

        const horarios = data.horarios || [];

        horarios.forEach(dia => {
            const diaNum = dia.dia_semana;

            // setear intervalo
            const intervaloInput = document.querySelector(`#dia-${diaNum} .intervalo-input`);
            if (intervaloInput) intervaloInput.value = dia.intervalo ?? 30;

            // limpiar bloques anteriores
            const cont = document.getElementById(`bloques-dia-${diaNum}`);
            cont.innerHTML = "";

            // cargar bloques
            dia.bloques.forEach(b => {
                const idx = cont.children.length;

                const html = obtenerHTMLBloque(idx, b);

                cont.insertAdjacentHTML("beforeend", html);
            });
        });

    } catch (err) {
        console.error(err);
        alert("No se pudieron cargar los horarios");
    }
}


document.addEventListener("DOMContentLoaded", cargarHorarios);

</script>

{% endblock js_final %}